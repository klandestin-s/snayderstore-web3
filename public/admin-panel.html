<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - SNAYDER'S STORE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" href="css/admin.css">
    <link rel="icon" href="https://raw.githubusercontent.com/klandestin-s/Cloud_v2/main/tmp/b281edce.png" />
  </head>
  <body>
    <div class="admin-container">
      <div id="adminPanel">
        <div class="admin-header">
          <h1 class="admin-title">SNAYDER'S STORE</h1>
          <p>Admin Panel - Kelola Produk dan Testimonial</p>
        </div>

        <div class="tabs">
          <button class="tab-btn active" data-tab="products">Produk</button>
          <button class="tab-btn" data-tab="trending">Produk Trending</button>
          <button class="tab-btn" data-tab="testimonials">Testimonial</button>
        </div>

        <!-- Produk Tab -->
        <div id="productsTab" class="tab-content active">
          <div class="admin-section">
            <h3><i class="fas fa-plus-circle"></i> Tambah Produk Baru</h3>
            <form id="productForm">
              <input type="hidden" id="productId" value="" />
              <div class="form-grid">
                <div class="form-group">
                  <label for="productName">Nama Produk</label>
                  <input type="text" id="productName" required />
                </div>

                <div class="form-group">
                  <label for="productImage">Link Gambar</label>
                  <input type="text" id="productImage" required />
                </div>

                <div class="form-group">
                  <label for="productPrice">Harga Dasar</label>
                  <input type="number" id="productPrice" required />
                </div>

                <div class="form-group">
                  <label for="productRating">Rating (1-5)</label>
                  <input type="number" id="productRating" min="0" max="5" step="0.1" value="0" required />
                </div>

                <div class="form-group">
                  <label for="productSold">Jumlah Terjual</label>
                  <input type="number" id="productSold" min="0" value="0" required />
                </div>

                <div class="form-group">
                  <label for="productViews">Jumlah Dilihat</label>
                  <input type="number" id="productViews" min="0" value="0" required />
                </div>

                <div class="form-group">
                  <label for="productDescription">Deskripsi Produk</label>
                  <textarea id="productDescription" required></textarea>
                </div>

                <div class="form-group">
                  <label for="productPackages">Paket (opsional)</label>
                  <textarea id="productPackages" placeholder="Format: Nama Paket - Harga (satu per baris)"></textarea>
                </div>
              </div>

              <div class="action-buttons">
                <button type="submit" class="btn-submit"><i class="fas fa-save"></i> Simpan Produk</button>
                <button type="button" id="cancelEditBtn" class="btn-submit btn-cancel" style="display: none"><i class="fas fa-times"></i> Batal</button>
              </div>
            </form>
            <div id="productStatus" class="status-message"></div>
          </div>

          <div class="admin-section">
            <h3><i class="fas fa-list"></i> Daftar Produk Tersedia</h3>
            <div id="productsList">
              <p style="text-align: center; padding: 20px; color: var(--text-muted)"><span class="loading"></span> Memuat daftar produk...</p>
            </div>
          </div>
        </div>

        <!-- Produk Trending Tab -->
        <div id="trendingTab" class="tab-content">
          <div class="admin-section">
            <h3><i class="fas fa-fire"></i> Produk Trending</h3>
            <p>Produk dengan rating di atas 4.5</p>
            <div id="trendingProductsList">
              <p style="text-align: center; padding: 20px; color: var(--text-muted)"><span class="loading"></span> Memuat produk trending...</p>
            </div>
          </div>
        </div>

        <!-- Testimonial Tab -->
        <div id="testimonialsTab" class="tab-content">
          <div class="admin-section">
            <h3><i class="fas fa-comment-medical"></i> Tambah Testimonial Baru</h3>
            <form id="testimonialForm">
              <input type="hidden" id="testimonialId" value="" />
              <div class="form-grid">
                <div class="form-group">
                  <label for="testimonialName">Nama Pelanggan</label>
                  <input type="text" id="testimonialName" required />
                </div>

                <div class="form-group">
                  <label for="testimonialProduct">Nama Produk</label>
                  <input type="text" id="testimonialProduct" required />
                </div>

                <div class="form-group">
                  <label for="testimonialRating">Rating (1-5)</label>
                  <input type="number" id="testimonialRating" min="1" max="5" required />
                </div>

                <div class="form-group">
                  <label for="testimonialImage">Link Gambar</label>
                  <input type="text" id="testimonialImage" required />
                </div>
              </div>

              <div class="action-buttons">
                <button type="submit" class="btn-submit"><i class="fas fa-save"></i> Simpan Testimonial</button>
                <button type="button" id="cancelTestimonialEditBtn" class="btn-submit btn-cancel" style="display: none"><i class="fas fa-times"></i> Batal</button>
              </div>
            </form>
            <div id="testimonialStatus" class="status-message"></div>
          </div>

          <div class="admin-section">
            <h3><i class="fas fa-comments"></i> Daftar Testimonial Tersedia</h3>
            <div id="testimonialsList">
              <p style="text-align: center; padding: 20px; color: var(--text-muted)"><span class="loading"></span> Memuat daftar testimonial...</p>
            </div>
          </div>
        </div>

        <!-- Tombol Logout -->
        <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>

    <!-- Modal Konfirmasi Hapus Produk -->
    <div class="modal" id="deleteModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Konfirmasi Hapus</h3>
          <button class="close-modal">&times;</button>
        </div>
        <p>Apakah Anda yakin ingin menghapus produk "<span id="deleteProductName"></span>"? Tindakan ini tidak dapat dibatalkan.</p>
        <div class="modal-buttons">
          <button class="btn-submit btn-cancel" id="cancelDelete"><i class="fas fa-times"></i> Batal</button>
          <button class="btn-submit btn-delete" id="confirmDelete"><i class="fas fa-trash"></i> Hapus</button>
        </div>
      </div>
    </div>

    <!-- Modal Konfirmasi Hapus Produk Trending -->
    <div class="modal" id="deleteTrendingModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Konfirmasi Hapus</h3>
          <button class="close-modal">&times;</button>
        </div>
        <p>Apakah Anda yakin ingin menghapus produk trending "<span id="deleteTrendingName"></span>"? Tindakan ini tidak dapat dibatalkan.</p>
        <div class="modal-buttons">
          <button class="btn-submit btn-cancel" id="cancelTrendingDelete"><i class="fas fa-times"></i> Batal</button>
          <button class="btn-submit btn-delete" id="confirmTrendingDelete"><i class="fas fa-trash"></i> Hapus</button>
        </div>
      </div>
    </div>

    <!-- Modal Konfirmasi Hapus Testimonial -->
    <div class="modal" id="deleteTestimonialModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Konfirmasi Hapus</h3>
          <button class="close-modal">&times;</button>
        </div>
        <p>Apakah Anda yakin ingin menghapus testimonial dari "<span id="deleteTestimonialName"></span>"? Tindakan ini tidak dapat dibatalkan.</p>
        <div class="modal-buttons">
          <button class="btn-submit btn-cancel" id="cancelTestimonialDelete"><i class="fas fa-times"></i> Batal</button>
          <button class="btn-submit btn-delete" id="confirmTestimonialDelete"><i class="fas fa-trash"></i> Hapus</button>
        </div>
      </div>
    </div>

    <script>
      // Konfigurasi API
      const API_BASE = "/api";
      const PRODUCTS_API = `${API_BASE}/products`;
      const TESTIMONIALS_API = `${API_BASE}/testimonials`;

      // Elemen DOM
      const adminPanel = document.getElementById("adminPanel");
      const productForm = document.getElementById("productForm");
      const testimonialForm = document.getElementById("testimonialForm");
      const tabBtns = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");
      const productsList = document.getElementById("productsList");
      const trendingProductsList = document.getElementById("trendingProductsList");
      const testimonialsList = document.getElementById("testimonialsList");
      const productIdInput = document.getElementById("productId");
      const testimonialIdInput = document.getElementById("testimonialId");
      const cancelEditBtn = document.getElementById("cancelEditBtn");
      const cancelTestimonialEditBtn = document.getElementById("cancelTestimonialEditBtn");
      const deleteModal = document.getElementById("deleteModal");
      const closeModalBtn = document.querySelector(".close-modal");
      const cancelDeleteBtn = document.getElementById("cancelDelete");
      const confirmDeleteBtn = document.getElementById("confirmDelete");
      const deleteProductName = document.getElementById("deleteProductName");
      const logoutBtn = document.getElementById("logoutBtn");
      const deleteTestimonialModal = document.getElementById("deleteTestimonialModal");
      const deleteTestimonialName = document.getElementById("deleteTestimonialName");
      const cancelTestimonialDeleteBtn = document.getElementById("cancelTestimonialDelete");
      const confirmTestimonialDeleteBtn = document.getElementById("confirmTestimonialDelete");
      const deleteTrendingModal = document.getElementById("deleteTrendingModal");
      const deleteTrendingName = document.getElementById("deleteTrendingName");
      const cancelTrendingDeleteBtn = document.getElementById("cancelTrendingDelete");
      const confirmTrendingDeleteBtn = document.getElementById("confirmTrendingDelete");

      // Variabel global
      let products = [];
      let testimonials = [];
      let productToDelete = null;
      let trendingToDelete = null;
      let testimonialToDelete = null;

      // Fungsi untuk menampilkan pesan status
      function showStatus(element, message, isSuccess = true) {
        element.textContent = message;
        element.className = isSuccess ? "status-message status-success" : "status-message status-error";
        element.style.display = "block";

        // Sembunyikan setelah 3 detik
        setTimeout(() => {
          element.style.display = "none";
        }, 3000);
      }

      // Fungsi untuk mengubah tab
      function switchTab(tabId) {
        // Nonaktifkan semua tab
        tabContents.forEach((tab) => {
          tab.classList.remove("active");
        });

        tabBtns.forEach((btn) => {
          btn.classList.remove("active");
        });

        // Aktifkan tab yang dipilih
        document.getElementById(`${tabId}Tab`).classList.add("active");
        document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add("active");

        // Jika tab trending diaktifkan, muat produk trending
        if (tabId === "trending") {
          loadTrendingProducts();
        }
      }

      // Fungsi untuk menampilkan modal konfirmasi hapus
      function showDeleteModal(product) {
        productToDelete = product;
        deleteProductName.textContent = product.name;
        deleteModal.classList.add("active");
      }

      // Fungsi untuk menyembunyikan modal
      function hideDeleteModal() {
        deleteModal.classList.remove("active");
        productToDelete = null;
      }

      // Fungsi untuk menampilkan modal konfirmasi hapus produk trending
      function showDeleteTrendingModal(product) {
        trendingToDelete = product;
        deleteTrendingName.textContent = product.name;
        deleteTrendingModal.classList.add("active");
      }

      // Fungsi untuk menyembunyikan modal trending
      function hideDeleteTrendingModal() {
        deleteTrendingModal.classList.remove("active");
        trendingToDelete = null;
      }

      // Fungsi untuk menampilkan modal konfirmasi hapus testimonial
      function showDeleteTestimonialModal(testimonial) {
        testimonialToDelete = testimonial;
        deleteTestimonialName.textContent = testimonial.name;
        deleteTestimonialModal.classList.add("active");
      }

      // Fungsi untuk menyembunyikan modal testimonial
      function hideDeleteTestimonialModal() {
        deleteTestimonialModal.classList.remove("active");
        testimonialToDelete = null;
      }

      // Fungsi untuk memuat daftar produk dari API
      async function loadProducts() {
        try {
          productsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-muted);"><span class="loading"></span> Memuat produk...</p>';

          const response = await fetch(PRODUCTS_API);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          products = await response.json();
          renderProducts(products);
        } catch (error) {
          productsList.innerHTML = `<p style="text-align: center; padding: 20px; color: var(--danger);">Gagal memuat produk: ${error.message}</p>`;
        }
      }

      // Fungsi untuk menampilkan produk
      function renderProducts(products) {
        if (!products || products.length === 0) {
          productsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-muted);">Belum ada produk tersedia</p>';
          return;
        }

        let html = `
            <table class="products-table">
                <thead>
                    <tr>
                        <th>Gambar</th>
                        <th>Nama Produk</th>
                        <th>Harga</th>
                        <th>Rating</th>
                        <th>Terjual</th>
                        <th>Dilihat</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
            `;

        products.forEach((product) => {
          const stars = "★".repeat(Math.round(product.rating || 0)) + "☆".repeat(5 - Math.round(product.rating || 0));

          html += `
                <tr>
                    <td>
                        <div class="product-image">
                            ${product.image ? `<img src="${product.image}" alt="${product.name}" width="60" height="60">` : `<i class="fas fa-image"></i>`}
                        </div>
                    </td>
                    <td>${product.name}</td>
                    <td>Rp${product.price.toLocaleString("id-ID")}</td>
                    <td><span class="star-rating">${stars}</span> (${product.rating || 0})</td>
                    <td>${product.sold || 0}</td>
                    <td>${product.views || 0}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" data-id="${product.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete-btn" data-id="${product.id}">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </td>
                </tr>
                `;
        });

        html += `
                </tbody>
            </table>
            `;

        productsList.innerHTML = html;

        // Tambahkan event listener untuk tombol edit dan hapus
        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", () => editProduct(btn.dataset.id));
        });

        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const product = products.find((p) => p.id === btn.dataset.id);
            if (product) showDeleteModal(product);
          });
        });
      }

      // Fungsi untuk memuat dan menampilkan produk trending
      async function loadTrendingProducts() {
        try {
          trendingProductsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-muted);"><span class="loading"></span> Memuat produk trending...</p>';

          const response = await fetch(PRODUCTS_API);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const allProducts = await response.json();
          const trendingProducts = allProducts.filter((product) => product.rating > 4.5);

          renderTrendingProducts(trendingProducts);
        } catch (error) {
          trendingProductsList.innerHTML = `<p style="text-align: center; padding: 20px; color: var(--danger);">Gagal memuat produk trending: ${error.message}</p>`;
        }
      }

      // Fungsi untuk menampilkan produk trending
      function renderTrendingProducts(trendingProducts) {
        if (!trendingProducts || trendingProducts.length === 0) {
          trendingProductsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-muted);">Belum ada produk trending</p>';
          return;
        }

        let html = `
            <table class="products-table">
                <thead>
                    <tr>
                        <th>Gambar</th>
                        <th>Nama Produk</th>
                        <th>Harga</th>
                        <th>Rating</th>
                        <th>Terjual</th>
                        <th>Dilihat</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
            `;

        trendingProducts.forEach((product) => {
          const stars = "★".repeat(Math.round(product.rating)) + "☆".repeat(5 - Math.round(product.rating));

          html += `
                <tr>
                    <td>
                        <div class="product-image">
                            ${product.image ? `<img src="${product.image}" alt="${product.name}" width="60" height="60">` : `<i class="fas fa-image"></i>`}
                        </div>
                    </td>
                    <td>${product.name}</td>
                    <td>Rp${product.price.toLocaleString("id-ID")}</td>
                    <td><span class="star-rating">${stars}</span> (${product.rating})</td>
                    <td>${product.sold}</td>
                    <td>${product.views}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" data-id="${product.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete-btn" data-id="${product.id}">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </td>
                </tr>
                `;
        });

        html += `
                </tbody>
            </table>
            `;

        trendingProductsList.innerHTML = html;

        // Tambahkan event listener
        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            editProduct(btn.dataset.id);
            switchTab("products"); // Pindah ke tab produk untuk edit
          });
        });

        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const product = products.find((p) => p.id === btn.dataset.id);
            if (product) showDeleteTrendingModal(product);
          });
        });
      }

      // Fungsi untuk mengisi form dengan data produk
      function editProduct(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) return;

        // Isi form dengan data produk
        document.getElementById("productName").value = product.name;
        document.getElementById("productImage").value = product.image || "";
        document.getElementById("productPrice").value = product.price;
        document.getElementById("productRating").value = product.rating || 0;
        document.getElementById("productSold").value = product.sold || 0;
        document.getElementById("productViews").value = product.views || 0;
        document.getElementById("productDescription").value = product.description;
        productIdInput.value = product.id;

        // Format paket untuk textarea
        if (product.packages && product.packages.length > 0) {
          const packagesText = product.packages.map((pkg) => `${pkg.name} - ${pkg.price}`).join("\n");
          document.getElementById("productPackages").value = packagesText;
        } else {
          document.getElementById("productPackages").value = "";
        }

        // Ubah teks tombol submit
        const submitBtn = productForm.querySelector(".btn-submit");
        submitBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Update Produk';
        submitBtn.classList.add("btn-edit");
        submitBtn.classList.remove("btn-submit");

        // Tampilkan tombol batal
        cancelEditBtn.style.display = "inline-block";

        // Scroll ke form
        productForm.scrollIntoView({ behavior: "smooth" });
      }

      // Fungsi untuk mengisi form testimonial
      function editTestimonial(testimonialId) {
        const testimonial = testimonials.find((t) => t.id === testimonialId);
        if (!testimonial) return;

        document.getElementById("testimonialName").value = testimonial.name;
        document.getElementById("testimonialProduct").value = testimonial.product;
        document.getElementById("testimonialRating").value = testimonial.rating;
        document.getElementById("testimonialImage").value = testimonial.image;
        testimonialIdInput.value = testimonial.id;

        // Ubah tombol submit
        const submitBtn = testimonialForm.querySelector(".btn-submit");
        submitBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Update Testimonial';
        submitBtn.classList.add("btn-edit");
        submitBtn.classList.remove("btn-submit");

        // Tampilkan tombol batal
        cancelTestimonialEditBtn.style.display = "inline-block";

        // Scroll ke form
        testimonialForm.scrollIntoView({ behavior: "smooth" });
      }

      // Fungsi untuk membatalkan edit
      function cancelEdit() {
        productForm.reset();
        productIdInput.value = "";

        // Kembalikan tombol submit ke semula
        const submitBtn = productForm.querySelector(".btn-submit");
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Produk';
        submitBtn.classList.remove("btn-edit");
        submitBtn.classList.add("btn-submit");

        // Sembunyikan tombol batal
        cancelEditBtn.style.display = "none";
      }

      // Fungsi untuk membatalkan edit testimonial
      function cancelTestimonialEdit() {
        testimonialForm.reset();
        testimonialIdInput.value = "";

        const submitBtn = testimonialForm.querySelector(".btn-submit");
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Testimonial';
        submitBtn.classList.remove("btn-edit");
        submitBtn.classList.add("btn-submit");

        cancelTestimonialEditBtn.style.display = "none";
      }

      // Fungsi untuk menghapus produk
      async function deleteProduct() {
        if (!productToDelete) return;

        const statusElement = document.getElementById("productStatus");

        try {
          const response = await fetch(`${PRODUCTS_API}?id=${productToDelete.id}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
          }

          // Muat ulang produk
          await loadProducts();
          showStatus(statusElement, `Produk "${productToDelete.name}" berhasil dihapus!`);
          hideDeleteModal();
        } catch (error) {
          showStatus(statusElement, `Gagal menghapus produk: ${error.message}`, false);
        }
      }

      // Fungsi untuk menghapus produk trending
      async function deleteTrendingProduct() {
        if (!trendingToDelete) return;

        const statusElement = document.getElementById("productStatus");

        try {
          const response = await fetch(`${PRODUCTS_API}?id=${trendingToDelete.id}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
          }

          // Muat ulang produk dan trending
          await loadProducts();
          await loadTrendingProducts();
          showStatus(statusElement, `Produk trending "${trendingToDelete.name}" berhasil dihapus!`);
          hideDeleteTrendingModal();
        } catch (error) {
          showStatus(statusElement, `Gagal menghapus produk trending: ${error.message}`, false);
        }
      }

      // Fungsi untuk menghapus testimonial
      async function deleteTestimonial() {
        if (!testimonialToDelete) return;

        const statusElement = document.getElementById("testimonialStatus");

        try {
          const response = await fetch(`${TESTIMONIALS_API}?id=${testimonialToDelete.id}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
          }

          await loadTestimonials();
          showStatus(statusElement, `Testimonial dari "${testimonialToDelete.name}" berhasil dihapus!`);
          hideDeleteTestimonialModal();
        } catch (error) {
          showStatus(statusElement, `Gagal menghapus testimonial: ${error.message}`, false);
        }
      }

      // Fungsi untuk mengirim produk ke API
      async function saveProduct(e) {
        e.preventDefault();
        const statusElement = document.getElementById("productStatus");
        const isEditMode = !!productIdInput.value;

        const product = {
          id: productIdInput.value || "prod" + Math.random().toString(36).substr(2, 9),
          name: document.getElementById("productName").value,
          image: document.getElementById("productImage").value,
          price: parseFloat(document.getElementById("productPrice").value),
          rating: parseFloat(document.getElementById("productRating").value),
          sold: parseInt(document.getElementById("productSold").value),
          views: parseInt(document.getElementById("productViews").value),
          description: document.getElementById("productDescription").value,
          packages: [],
        };

        // Parsing paket jika ada
        const packagesText = document.getElementById("productPackages").value.trim();
        if (packagesText) {
          const packageLines = packagesText.split("\n");
          product.packages = packageLines
            .map((line) => {
              const [name, price] = line.split("-").map((part) => part.trim());
              return {
                name,
                price: parseFloat(price.replace(/\D/g, "")),
              };
            })
            .filter((pkg) => pkg.name && !isNaN(pkg.price));
        }

        try {
          const method = isEditMode ? "PUT" : "POST";
          const response = await fetch(PRODUCTS_API, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(product),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
          }

          showStatus(statusElement, isEditMode ? "Produk berhasil diperbarui!" : "Produk baru berhasil disimpan!");

          // Muat ulang produk
          await loadProducts();
          cancelEdit();
        } catch (error) {
          showStatus(statusElement, `Terjadi kesalahan: ${error.message}`, false);
        }
      }

      // Fungsi untuk mengirim testimonial ke API
      async function saveTestimonial(e) {
        e.preventDefault();
        const statusElement = document.getElementById("testimonialStatus");
        const isEditMode = !!testimonialIdInput.value;

        const testimonial = {
          id: testimonialIdInput.value || Math.random().toString(36).substr(2, 9), // Generate new id
          name: document.getElementById("testimonialName").value,
          product: document.getElementById("testimonialProduct").value,
          image: document.getElementById("testimonialImage").value,
          rating: parseInt(document.getElementById("testimonialRating").value),
          date: isEditMode ? testimonials.find((t) => t.id === testimonialIdInput.value).date : new Date().toISOString().split("T")[0],
          verified: true, // selalu verified karena diinput admin
        };

        // Validasi frontend
        if (!testimonial.name || !testimonial.product || !testimonial.image || isNaN(testimonial.rating)) {
          showStatus(statusElement, "Harap isi semua field yang wajib diisi: Nama, Produk, Rating, dan Gambar", false);
          return;
        }

        try {
          const method = isEditMode ? "PUT" : "POST";
          const response = await fetch(TESTIMONIALS_API, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(testimonial),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
          }

          showStatus(statusElement, isEditMode ? "Testimonial berhasil diperbarui!" : "Testimonial baru berhasil disimpan!");
          testimonialForm.reset();
          testimonialIdInput.value = "";
          await loadTestimonials();
          cancelTestimonialEdit();
        } catch (error) {
          showStatus(statusElement, `Terjadi kesalahan: ${error.message}`, false);
        }
      }

      // Fungsi untuk memuat daftar testimonial
      async function loadTestimonials() {
        try {
          testimonialsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-muted);"><span class="loading"></span> Memuat testimonial...</p>';

          const response = await fetch(TESTIMONIALS_API);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          testimonials = await response.json();
          renderTestimonials(testimonials);
        } catch (error) {
          testimonialsList.innerHTML = `<p style="text-align: center; padding: 20px; color: var(--danger);">Gagal memuat testimonial: ${error.message}</p>`;
        }
      }

      // Fungsi untuk menampilkan testimonial
      function renderTestimonials(testimonials) {
        if (!testimonials || testimonials.length === 0) {
          testimonialsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-muted);">Belum ada testimonial tersedia</p>';
          return;
        }

        let html = `
            <table class="products-table">
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th>Rating</th>
                        <th>Produk</th>
                        <th>Tanggal</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
            `;

        testimonials.forEach((testimonial) => {
          const stars = "★".repeat(testimonial.rating) + "☆".repeat(5 - testimonial.rating);

          html += `
                <tr>
                    <td>${testimonial.name}</td>
                    <td><span class="star-rating">${stars}</span></td>
                    <td>${testimonial.product}</td>
                    <td>${testimonial.date}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" data-id="${testimonial.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete-btn" data-id="${testimonial.id}">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </td>
                </tr>
                `;
        });

        html += `
                </tbody>
            </table>
            `;

        testimonialsList.innerHTML = html;

        // Tambahkan event listener
        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", () => editTestimonial(btn.dataset.id));
        });

        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const testimonial = testimonials.find((t) => t.id === btn.dataset.id);
            if (testimonial) showDeleteTestimonialModal(testimonial);
          });
        });
      }

      // Event Listeners
      productForm.addEventListener("submit", saveProduct);
      testimonialForm.addEventListener("submit", saveTestimonial);
      cancelEditBtn.addEventListener("click", cancelEdit);
      cancelTestimonialEditBtn.addEventListener("click", cancelTestimonialEdit);
      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("adminLoggedIn");
        window.location.href = "index.html";
      });

      tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          switchTab(btn.dataset.tab);
        });
      });

      // Event listener untuk modal produk
      closeModalBtn.addEventListener("click", hideDeleteModal);
      cancelDeleteBtn.addEventListener("click", hideDeleteModal);
      confirmDeleteBtn.addEventListener("click", deleteProduct);

      // Event listener untuk modal produk trending
      document.querySelectorAll("#deleteTrendingModal .close-modal").forEach((btn) => {
        btn.addEventListener("click", hideDeleteTrendingModal);
      });
      cancelTrendingDeleteBtn.addEventListener("click", hideDeleteTrendingModal);
      confirmTrendingDeleteBtn.addEventListener("click", deleteTrendingProduct);

      // Event listener untuk modal testimonial
      document.querySelectorAll("#deleteTestimonialModal .close-modal").forEach((btn) => {
        btn.addEventListener("click", hideDeleteTestimonialModal);
      });
      cancelTestimonialDeleteBtn.addEventListener("click", hideDeleteTestimonialModal);
      confirmTestimonialDeleteBtn.addEventListener("click", deleteTestimonial);

      // Inisialisasi
      document.addEventListener("DOMContentLoaded", () => {
        // Simulasi login untuk demo
        localStorage.setItem("adminLoggedIn", "true");

        loadProducts();
        loadTestimonials();
      });
    </script>
  </body>
</html>
